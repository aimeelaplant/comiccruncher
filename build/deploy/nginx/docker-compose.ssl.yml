version: "3.4"
services:
  certbot:
    container_name: certbot
    image: certbot/dns-route53:v0.30.0
    entrypoint: >
      sh -c "certbot certonly -n --dry-run --dns-route53 --agree-tos --email aimee@aimeelaplant.com -d api.comiccruncher.com &&
      trap exit TERM; while :; do certbot renew --dry-run; sleep 24h & wait $${!}; done;"
    environment:
    - "AWS_ACCESS_KEY_ID=${AWS_SSL_ACCESS_KEY_ID}"
    - "AWS_SECRET_ACCESS_KEY=${AWS_SSL_SECRET_ACCESS_KEY}"
    volumes:
    - letsencrypt:/etc/letsencrypt
    - ./letsencrypt:/etc/letsencrypt
    logging:
      options:
        max-size: "25M"
        max-file: "3"
  datadog:
    depends_on:
      - certbot
    container_name: datadog
    restart: always
    image: datadog/agent:6.8.3
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /proc/:/host/proc/:ro
      - /sys/fs/cgroup/:/host/sys/fs/cgroup:ro
    environment:
      DD_API_KEY: "${CC_DD_API_KEY}"
      DD_LOGS_ENABLED: "true"
      DD_LOGS_CONFIG_CONTAINER_COLLECT_ALL: "true"
      DD_AC_EXCLUDE: "name:datadog"
      DD_ENABLE_PAYLOADS_EVENTS: "false"
      DD_ENABLE_PAYLOADS_SERIES: "false"
      DD_ENABLE_PAYLOADS_SERVICE_CHECKS: "false"
      DD_ENABLE_PAYLOADS_SKETCHES: "false"
volumes:
  letsencrypt:
