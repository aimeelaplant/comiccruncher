version: "3.4"
services:
  api:
    restart: always
    depends_on:
      - filebeat
      - telegraf
    container_name: api
    image: comiccruncher/api:latest
    ports:
      - "8001:8001"
    environment:
      - "CC_CDN_URL=${CC_CDN_URL}"
      - "CC_ENVIRONMENT=${CC_ENVIRONMENT:-production}"
      - "CC_REDIS_HOST=${CC_REDIS_HOST}"
      - "CC_REDIS_PORT=${CC_REDIS_PORT}"
      - "CC_REDIS_PASSWORD=${CC_REDIS_PASSWORD}"
      - "CC_POSTGRES_HOST=${CC_POSTGRES_HOST}"
      - "CC_POSTGRES_PORT=${CC_POSTGRES_PORT}"
      - "CC_POSTGRES_DB=${CC_POSTGRES_DB}"
      - "CC_POSTGRES_USER=${CC_POSTGRES_USER}"
      - "CC_POSTGRES_PASSWORD=${CC_POSTGRES_PASSWORD}"
      - "CC_AUTH_TOKEN=${CC_AUTH_TOKEN}"
      - "CC_JWT_SIGNING_SECRET=${CC_JWT_SIGNING_SECRET:-default}"
      - "CC_JWT_AUTH_SECRET=${CC_JWT_AUTH_SECRET:-default}"
    logging:
      options:
        max-size: "25M"
        max-file: "3"
    labels:
      - "co.elastic.logs/fileset.stdout=access"
      - "co.elastic.logs/fileset.stderr=error"
  telegraf:
    container_name: telegraf
    restart: always
    image: telegraf:1.9-alpine
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./telegraf.conf:/etc/telegraf/telegraf.conf:ro
    logging:
      options:
        max-size: "25M"
        max-file: "3"
    environment:
      HOSTNAME: "${HOSTNAME}"
  filebeat:
    command: ["--strict.perms=false"]
    restart: always
    user: root
    container_name: filebeat
    image: docker.elastic.co/beats/filebeat:6.5.4
    volumes:
    - /var/run/docker.sock:/var/run/docker.sock
    - /var/lib/docker/containers:/var/lib/docker/containers:ro
    - filebeat:/usr/share/filebeat/data
    - ./filebeat.yml:/usr/share/filebeat/filebeat.yml
    logging:
      options:
        max-size: "25M"
        max-file: "3"
    environment:
      CC_ENVIRONMENT: "${CC_ENVIRONMENT:-production}"
      HOSTNAME: "${HOSTNAME}"
      ELASTIC_HOST: "10.136.103.144:9200"
      ELASTIC_USER: "${CC_ELASTIC_USER}"
      ELASTIC_PASSWORD: "${CC_ELASTIC_PASSWORD}"
      KIBANA_HOST: "${CC_KIBANA_HOST}"
      KIBANA_USER: "${CC_KIBANA_USER}"
      KIBANA_PASSWORD: "${CC_KIBANA_PASSWORD}"
volumes:
  filebeat:
